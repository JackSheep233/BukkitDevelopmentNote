<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>服务端与客户端 | Bukkit Development Note</title>
    <meta name="description" content="A guide to develop Minecraft Server plugins based on Bukkit.">
    <meta name="generator" content="VuePress 1.4.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
    
    <link rel="preload" href="/BukkitDevelopmentNote/assets/css/0.styles.306dc64a.css" as="style"><link rel="preload" href="/BukkitDevelopmentNote/assets/js/app.2634dd99.js" as="script"><link rel="preload" href="/BukkitDevelopmentNote/assets/js/2.cc6e75aa.js" as="script"><link rel="preload" href="/BukkitDevelopmentNote/assets/js/13.848a50a7.js" as="script"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/10.e1cfcf7a.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/11.44efa5f5.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/12.3917c9a1.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/14.d3d0e1c2.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/15.3d1313bf.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/16.4dd55a1e.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/17.ece6e639.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/18.ac97681d.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/19.396f060b.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/20.90cd3f0c.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/21.f6b39766.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/22.938c6544.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/23.f53b8e95.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/24.c4052a83.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/25.f7321946.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/26.548249ca.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/27.e2b64422.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/28.ed2628f6.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/29.1c742d23.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/3.c1f93749.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/30.04dcb996.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/31.b2bccbe9.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/32.6ab03692.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/33.222886c9.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/34.fe917ab1.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/35.c3502896.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/36.62f3d555.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/37.39042c08.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/38.d83a6a0c.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/4.2f54bf03.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/5.ec88f9e9.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/6.8d881c35.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/7.4444e5b6.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/8.4b9b39e0.js"><link rel="prefetch" href="/BukkitDevelopmentNote/assets/js/9.c2d8b702.js">
    <link rel="stylesheet" href="/BukkitDevelopmentNote/assets/css/0.styles.306dc64a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/BukkitDevelopmentNote/" class="home-link router-link-active"><!----> <span class="site-name">Bukkit Development Note</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/BukkitDevelopmentNote/home.html" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/BukkitDevelopmentNote/contribute.html" class="nav-link">
  贡献
</a></div><div class="nav-item"><a href="https://alpha.tdiant.net/donate.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  赞助
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/tdiant/BukkitDevelopmentNote" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub仓库
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/BukkitDevelopmentNote/home.html" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/BukkitDevelopmentNote/contribute.html" class="nav-link">
  贡献
</a></div><div class="nav-item"><a href="https://alpha.tdiant.net/donate.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  赞助
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/tdiant/BukkitDevelopmentNote" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub仓库
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/BukkitDevelopmentNote/home.html" class="sidebar-link">欢迎</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>第一部分: 基本概念</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/BukkitDevelopmentNote/unit/1-1.html" class="sidebar-link">写在前面</a></li><li><a href="/BukkitDevelopmentNote/unit/1-2.html" class="sidebar-link">MC的服务端介绍</a></li><li><a href="/BukkitDevelopmentNote/unit/1-3.html" class="sidebar-link">代码中的MC世界</a></li><li><a href="/BukkitDevelopmentNote/unit/1-4.html" class="sidebar-link">检索需要的信息</a></li><li><a href="/BukkitDevelopmentNote/unit/1-5.html" class="active sidebar-link">服务端与客户端</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/BukkitDevelopmentNote/unit/1-5.html#永远不能相信客户端" class="sidebar-link">永远不能相信客户端</a></li><li class="sidebar-sub-header"><a href="/BukkitDevelopmentNote/unit/1-5.html#理清楚客户端和服务端的关系" class="sidebar-link">理清楚客户端和服务端的关系</a></li><li class="sidebar-sub-header"><a href="/BukkitDevelopmentNote/unit/1-5.html#uuid和玩家名" class="sidebar-link">UUID和玩家名</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第二部分: 基础内容</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/BukkitDevelopmentNote/unit/2-1.html" class="sidebar-link">最简单的插件</a></li><li><a href="/BukkitDevelopmentNote/unit/2-2.html" class="sidebar-link">事件的监听</a></li><li><a href="/BukkitDevelopmentNote/unit/2-3.html" class="sidebar-link">配置API</a></li><li><a href="/BukkitDevelopmentNote/unit/2-4.html" class="sidebar-link">命令执行器</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第三部分: 进阶功能</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/BukkitDevelopmentNote/unit/3-2.html" class="sidebar-link">自定义事件</a></li><li><a href="/BukkitDevelopmentNote/unit/3-3.html" class="sidebar-link">深入plugin.yml</a></li><li><a href="/BukkitDevelopmentNote/unit/3-4.html" class="sidebar-link">配置API的序列化和遍历</a></li><li><a href="/BukkitDevelopmentNote/unit/3-5.html" class="sidebar-link">多线程多任务框架</a></li><li><a href="/BukkitDevelopmentNote/unit/3-6.html" class="sidebar-link">自定义合成表</a></li><li><a href="/BukkitDevelopmentNote/unit/3-7.html" class="sidebar-link">粒子效果和音效播放</a></li><li><a href="/BukkitDevelopmentNote/unit/3-8.html" class="sidebar-link">世界生成器</a></li><li><a href="/BukkitDevelopmentNote/unit/3-9.html" class="sidebar-link">Title、Bar与计分板显示</a></li><li><a href="/BukkitDevelopmentNote/unit/3-10.html" class="sidebar-link">经验和成就</a></li><li><a href="/BukkitDevelopmentNote/unit/3-11.html" class="sidebar-link">插件系统基本玩法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第四部分: 常用依赖</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/BukkitDevelopmentNote/unit/4-1.html" class="sidebar-link">Vault</a></li><li><a href="/BukkitDevelopmentNote/unit/4-2.html" class="sidebar-link">ProtocolLib</a></li><li><a href="/BukkitDevelopmentNote/unit/4-3.html" class="sidebar-link">Bungeecord</a></li><li><a href="/BukkitDevelopmentNote/unit/4-4.html" class="sidebar-link">PlaceholderAPI</a></li><li><a href="/BukkitDevelopmentNote/unit/4-5.html" class="sidebar-link">VexView</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>第五部分: 底层部分</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/BukkitDevelopmentNote/unit/5-1.html" class="sidebar-link">认识NMS与OBC</a></li><li><a href="/BukkitDevelopmentNote/unit/5-2.html" class="sidebar-link">自定义发包</a></li><li><a href="/BukkitDevelopmentNote/unit/5-3.html" class="sidebar-link">NBT数据操作</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="服务端与客户端"><a href="#服务端与客户端" class="header-anchor">#</a> 服务端与客户端</h1> <h2 id="永远不能相信客户端"><a href="#永远不能相信客户端" class="header-anchor">#</a> 永远不能相信客户端</h2> <p>有人说, 从游戏行业诞生的那一刻, 也是游戏反作弊诞生的那一刻.<br>
客户端给的数据不能轻易相信. 在开发插件时一定要注意, 如果你的插件要接收某个信息, 这个信息不是你自己指定的, 而是服主设置配置文件自己设定的或者是客户端发来的, 那你一定要仔细思考, 多加留意.</p> <p>虽然不是服务器插件开发圈的事情, 但是这件事情为我们敲响了警钟.<br>
2020年2月, MCBBS网站以及线下圈子内突然爆发一股针对Minecraft 1.12版本MOD漏洞的争议.<br> <a href="https://www.mcbbs.net/thread-968903-1-1.html" target="_blank" rel="noopener noreferrer">https://www.mcbbs.net/thread-968903-1-1.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>早前在GitHub上, 一个来自俄罗斯的账户发布了一个作弊MOD.<br>
这款作弊MOD的作者研究了各大主流MOD的协议包漏洞, 发现这些知名的大MOD的协议包或多或少在接收到玩家客户端数据时, <strong>对玩家客户端发来的数据的合理性判定极度缺失, 甚至是根本没有</strong>.<br>
(不恰当的比方)玩家客户端说自己有一百万个钻石, 服务端真的就认为玩家客户端有一百万个钻石. 因此, 这款作弊MOD针对主流的大MOD的这些协议包问题, 有针对性的对每个MOD都开发了作弊方案.</p> <p>作弊MOD事件过后, VexView的作者这样回应这一问题(以下节选有删改):</p> <blockquote><p>“没错, VexView很幸运, 同样存在这个BUG, 而且存在于 1.7.10-1.14 全版本. 但是不用担心, 我们当初在设计的时候就已经考虑到这个问题. 同时我们在开发文档中也明确指出要保持谨慎. 如果附属插件能够正常处理, 应该不会出现这些问题的. 当然不排除某些附属插件逻辑就不会存在此类刷物品的漏洞. <strong>这完全取决于附属开发者</strong>.”</p></blockquote> <p>可见开发者对客户端的警惕意识有多么重要.</p> <p>我们要编写的是服务端插件.<br>
服务端插件根本上面向于这一服务器的玩家, 最直接的使用者是这一服务器的服主. 那么, 服主能不能正确配置配置文件? 玩家的数据信息真的正确吗?<br>
也许你说, 你写的又不是反作弊插件, 不可能做到处处提防玩家. 诚然如此, 但是警惕意识绝对不能丢.</p> <p><strong>先虑忧患, 享于安乐.</strong></p> <h2 id="理清楚客户端和服务端的关系"><a href="#理清楚客户端和服务端的关系" class="header-anchor">#</a> 理清楚客户端和服务端的关系</h2> <p>如果你有经验你应该知道, 装上<code>Resdience</code>插件后, 创建一个领地, 关闭领地所有玩家的移动权限, 把一个玩家扔进去, 玩家在里面试图移动的话, 效果并不是完全动不了, 而是玩家仍然可以运动, 但是在一个间隔时间之后会被“弹回来”. 这是为什么?</p> <p>为什么最终的效果不是&quot;玩家一点都动不了&quot;呢?</p> <p>事实上, 我们无法在服务端取消玩家一点也不能移动. 客户端移动玩家时, 会在客户端显示出移动后的样子, 然后才会传递给服务器玩家移动的信号, 服务端收到客户端的信号后, 服务器才会做出响应.</p> <p>也就是说, 客户端与服务端之间, <strong>客户端往往都是&quot;先斩后奏&quot;的</strong>. 客户端不管你服务端想干什么, 先那么显示出来再说. 因为毕竟玩家在服务器里完全动不了不是MC原版的设定之一.</p> <h2 id="uuid和玩家名"><a href="#uuid和玩家名" class="header-anchor">#</a> UUID和玩家名</h2> <p>Minecraft在1.8版本的更新中隆重引入了UUID, 以便正版玩家修改自己的游戏ID且游戏内数据不变.<br>
这意味着从此以后服务端区分玩家的判据不再是玩家的ID, 而是UUID.</p> <p>正版服务器不必多说, 通过Mojang提供的API, 服务端可以得知一个进入服务器的玩家的UUID, 数据按照玩家的UUID存储即可.<br>
但是离线服务器怎么办呢? 答案是根据玩家名计算.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//下面的代码出自OBC的CraftPlayerProfile类</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>isOnlineMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    profile <span class="token operator">=</span> lookupName <span class="token operator">?</span> userCache<span class="token punctuation">.</span><span class="token function">getProfile</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">:</span> userCache<span class="token punctuation">.</span><span class="token function">getProfileIfCached</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    profile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GameProfile</span><span class="token punctuation">(</span>UUID<span class="token punctuation">.</span><span class="token function">nameUUIDFromBytes</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;OfflinePlayer:&quot;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">Charsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre></div><p>可见盗版玩家的UUID计算的是<code>OfflinePlayer:玩家名</code>对应的UUID.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/BukkitDevelopmentNote/unit/1-4.html" class="prev">
        检索需要的信息
      </a></span> <span class="next"><a href="/BukkitDevelopmentNote/unit/2-1.html">
        最简单的插件
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/BukkitDevelopmentNote/assets/js/app.2634dd99.js" defer></script><script src="/BukkitDevelopmentNote/assets/js/2.cc6e75aa.js" defer></script><script src="/BukkitDevelopmentNote/assets/js/13.848a50a7.js" defer></script>
  </body>
</html>
