# 坑

**这一部分放在了最前面, 但是这一部分并不是基础部分.**  
**若你仍在熟悉BukkitAPI的阶段, 请跳过.**

BukkitAPI现在已经相对成熟. 但是有些东西在实际开发过程中十分坑, 是先前的开发者踩过的坑.  

本文收录不一定全面, 会收录教程中提到的所有的坑.

## 事件

### PlayerMoveEvent取消后玩家仍然可以移动, 但是会被“拉回来”.

一般情况下, 如果要实现真正的让玩家站在某个位置一动不动, 你可以在取消该事件的基础上, 临时使用`player.setWalkSpeed`和`player.setFlySpeed`将玩家的各种速度设置为`0`, 等想解除的时候设置回原来的数值.

### 玩家打开背包无法被监听

玩家打开背包时, 客户端根本不会给服务端发送数据包, 你根本不能监听玩家打开自己背包这一事件.  

一般如果要实现禁止玩家打开背包, 其实最常规的做法就是开一个`BukkitRunnable`, 定时调用`p.closeInventory()`关闭玩家正在打开的背包实现的.  
感兴趣可以看看这个帖子: [https://www.mcbbs.net/thread-965760-1-1.html](https://www.mcbbs.net/thread-965760-1-1.html)  

### 玩家登录时操作玩家对象会报错

登录事件有很多种, 这里简单介绍其中的两种.

在玩家尝试连接服务器时, 会触发`PlayerLoginEvent`, 此时你不可以操控玩家`Player`对象获取其背包等信息, 而仅可以获取UUID、玩家名和网络信息(IP等)等, 因为这一事件触发只是相当于说“我要进来了啊”.  
玩家完全地进入服务器后, 会触发`PlayerJoinEvent`, 服务器内将会出现玩家实体. 此时你可以当做玩家完全进入服务器, 对其自由操作.

### PlayerInteractEvent监听玩家右键方块会被触发两遍

在高版本里, 玩家右键一个方块的过程是两步, 触发两遍的原因是玩家的主手和副手都同时右键了该方块.  
也就是, 你还需要处理一下`getHand()`判断玩家究竟是哪个手右击的方块.

低版本根本没副手, 所以没这个问题.

## 配置文件

### 修改了配置文件内容后再读取是最新数据, 但是文件里的数据没有更新

```java
getConfig().set("your_key",your_value); //你这样修改完之后
saveConfig(); //你还要这样保存一下, 才能存到硬盘文件里
```

## 其他操作

### 操作离线玩家背包报错

你只能借助NMS来操作, 不能直接操作离线玩家的背包.  
你可以参考`OpenInv`插件的做法.

### 判断玩家是否第一次进入服务器

Player对象有一个`hasPlayedBefore`方法, 这一方法的运作原理是判断是否有玩家的数据文件.  
如果玩家第一次进入了一个服务器, 必然会为它创建一个数据文件, 玩家进入服务器后再去使用`hasPlayedBefore`方法, 由于数据文件已经存在, 它不能判断玩家是否第一次进入服务器.

因此`hasPlayedBefore`的正确理解是玩家有没有进过这个服务器, 而如果需要判断玩家这次进入服务器是不是第一次进入, 应当使用`getFirstPlayed`方法获取玩家第一次进入服务器的时间, 与当前时间戳比对.
